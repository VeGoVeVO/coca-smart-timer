name: Build and Release COCA Smart Timer

on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

permissions:
  contents: write
  packages: write

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install system dependencies
      run: |
        # Install Tesseract OCR using chocolatey (more reliable)
        choco install tesseract --yes
        # Add Tesseract to PATH
        $env:PATH += ";C:\Program Files\Tesseract-OCR"
        echo "C:\Program Files\Tesseract-OCR" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Build executable
      run: |
        pyinstaller --onedir --windowed --name "COCA-Smart-Timer" --icon "coca_timer/assets/coca_logo.png" --add-data "coca_timer/assets;assets" --add-data "coca_timer;coca_timer" launcher.py
        
    - name: Create release package
      run: |
        mkdir release
        # Copy the entire distribution folder
        xcopy /E /I dist\COCA-Smart-Timer release\COCA-Smart-Timer
        copy README.md release\
        echo "COCA Smart Timer v${{ github.event.inputs.version || github.ref_name }}" > release\VERSION.txt
        echo "Built on $(Get-Date)" >> release\VERSION.txt
        echo "" >> release\VERSION.txt
        echo "To run: Execute COCA-Smart-Timer.exe inside the COCA-Smart-Timer folder" >> release\VERSION.txt
        
    - name: Create ZIP archive
      run: |
        # Create a clean ZIP without nested folders
        cd release
        Compress-Archive -Path * -DestinationPath "..\COCA-Smart-Timer-${{ github.event.inputs.version || github.ref_name }}-Windows.zip"
        cd ..
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: COCA-Smart-Timer-Windows-${{ github.sha }}
        path: "COCA-Smart-Timer-*.zip"

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.event.inputs.version || github.ref_name }}
        name: "COCA Smart Timer ${{ github.event.inputs.version || github.ref_name }}"
        body: |
          ## COCA Smart Timer Release
          
          ### Features
          - 🎯 Smart OCR percentage detection
          - ⏱️ Automatic timer calculation based on detected percentage
          - 🎮 Gaming-friendly floating overlay
          - 🔧 Customizable trigger words
          - 🎨 Coca leaf themed UI
          - 🔊 Nature-inspired completion sounds
          - 📍 Multiple overlay positions
          - 💾 Persistent settings
          
          ### Installation
          1. Download the ZIP file
          2. Extract to your desired location
          3. Run `COCA-Smart-Timer.exe`
          4. Right-click the system tray icon to configure
          
          ### Requirements
          - Windows 10/11
          - Tesseract OCR (included in installer)
          
          Built with ❤️ for the gaming community.
        files: |
          COCA-Smart-Timer-*.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
